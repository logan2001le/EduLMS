import { DataSourceDecorator } from "../../Shared/Framework/DataSourceDecorator";
import { CometChatMessageEvents, CometChatUIKitConstants, MessageStatus } from "@cometchat/uikit-resources";
import { CometChatMessageTemplate } from "@cometchat/uikit-resources";
import { CometChat } from '@cometchat/chat-sdk-javascript';
import { localize } from '@cometchat/uikit-resources';
import { StickersConfiguration } from '@cometchat/uikit-shared';
import { StickersConstants } from '@cometchat/uikit-shared';
import { CometChatSoundManager, CometChatUIKitUtility } from "@cometchat/uikit-shared";
import { ChatConfigurator } from "../../Shared/Framework/ChatConfigurator";
import { CometChatException } from "../../Shared/Utils/ComeChatException";
export class StickersExtensionDecorator extends DataSourceDecorator {
    constructor(dataSource) {
        super(dataSource);
        this.sendStickerMessage = (sticker, loggedInUser, user, group, parentMessageid, onError, customSoundForMessages = "", disableSoundForMessages = false) => {
            let receiverId = user?.getUid() || group?.getGuid();
            let receiverType = user ? CometChatUIKitConstants.MessageReceiverType.user : CometChatUIKitConstants.MessageReceiverType.group;
            try {
                const customData = {
                    sticker_url: sticker.url,
                    sticker_name: sticker.name,
                };
                const customType = StickersConstants.sticker;
                const customMessage = new CometChat.CustomMessage(receiverId, receiverType, customType, customData);
                if (parentMessageid) {
                    customMessage.setParentMessageId(parentMessageid);
                }
                customMessage.setMetadata({ incrementUnreadCount: true });
                customMessage.setSentAt(CometChatUIKitUtility.getUnixTimestamp());
                customMessage.setMuid(CometChatUIKitUtility.ID());
                CometChatMessageEvents.ccMessageSent.next({
                    message: customMessage,
                    status: MessageStatus.inprogress
                });
                if (!disableSoundForMessages) {
                    CometChatSoundManager.play(customSoundForMessages ?? CometChatSoundManager.Sound.outgoingMessage);
                }
                CometChat.sendCustomMessage(customMessage)
                    .then((message) => {
                    CometChatMessageEvents.ccMessageSent.next({
                        message: message,
                        status: MessageStatus.success
                    });
                })
                    .catch((error) => {
                    customMessage.setMetadata({
                        error: true
                    });
                    CometChatMessageEvents.ccMessageSent.next({
                        message: customMessage,
                        status: MessageStatus.error,
                    });
                });
            }
            catch (error) {
                if (onError) {
                    onError(CometChatException(error));
                }
            }
        };
        this.newDataScorce = dataSource;
        this.configuration = new StickersConfiguration({});
        this.configuration.ccStickerClicked = this.sendStickerMessage;
    }
    getDataScorce() {
        return this.newDataScorce;
    }
    getAllMessageTemplates() {
        let template = super.getAllMessageTemplates();
        if (!this.checkIfTemplateExist(template, StickersConstants.sticker)) {
            template.push(this.getStickerTemplate());
            return template;
        }
        return template;
    }
    getAuxiliaryOptions(id, user, group) {
        return { configuration: this.configuration, id: StickersConstants.sticker };
    }
    getStickerTemplate() {
        return new CometChatMessageTemplate({
            type: StickersConstants.sticker,
            category: CometChatUIKitConstants.MessageCategory.custom,
            options: (loggedInUser, messageObject, theme, group) => {
                return ChatConfigurator.getDataSource().getCommonOptions(loggedInUser, messageObject, theme, group);
            }
        });
    }
    checkIfTemplateExist(template, type) {
        return template.some(obj => obj.type === type);
    }
    getAllMessageCategories() {
        let categories = super.getAllMessageCategories();
        if (!categories.some(category => category === CometChatUIKitConstants.MessageCategory.custom)) {
            categories.push(CometChatUIKitConstants.MessageCategory.custom);
        }
        return categories;
    }
    getAllMessageTypes() {
        let types = super.getAllMessageTypes();
        if (!types.some(category => category === CometChatUIKitConstants.MessageCategory.custom)) {
            types.push(StickersConstants.sticker);
        }
        return types;
    }
    getId() {
        return "stickers";
    }
    getLastConversationMessage(conversation, loggedInUser) {
        const message = conversation.getLastMessage();
        if (message != null && message.getType() == StickersConstants.sticker && message.getCategory() == CometChatUIKitConstants.MessageCategory.custom) {
            return localize("CUSTOM_MESSAGE_STICKER");
        }
        else {
            return super.getLastConversationMessage(conversation, loggedInUser);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RpY2tlcnNFeHRlbnNpb25EZWNvcmF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jaGF0LXVpa2l0LWFuZ3VsYXIvc3JjL0V4dGVuc2lvbnMvU3RpY2tlcnMvU3RpY2tlcnNFeHRlbnNpb25EZWNvcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFHLG1CQUFtQixFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFDbEYsT0FBTyxFQUFFLHNCQUFzQixFQUFrQix1QkFBdUIsRUFBRSxhQUFhLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM1SCxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN0RSxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sZ0NBQWdDLENBQUE7QUFDeEQsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLDRCQUE0QixDQUFBO0FBQ25ELE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLHlCQUF5QixDQUFBO0FBQzdELE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHlCQUF5QixDQUFBO0FBRXpELE9BQU8sRUFBRSxxQkFBcUIsRUFBQyxxQkFBcUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3RGLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBRTNFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQzFFLE1BQU0sT0FBTywwQkFBMkIsU0FBUSxtQkFBbUI7SUFHbEUsWUFBWSxVQUFxQjtRQUM3QixLQUFLLENBQUMsVUFBVSxDQUFDLENBQUE7UUFRckIsdUJBQWtCLEdBQUcsQ0FBQyxPQUFnQyxFQUFDLFlBQTJCLEVBQUMsSUFBbUIsRUFBQyxLQUFxQixFQUFDLGVBQXNCLEVBQUMsT0FBdUUsRUFBQyx5QkFBZ0MsRUFBRSxFQUFFLDBCQUFrQyxLQUFLLEVBQUMsRUFBRTtZQUN4UyxJ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LENBQUMsdUJBQXVCLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1NBQ2hFO1FBQ0MsT0FBTyxVQUFVLENBQUE7SUFDcEIsQ0FBQztJQUdVLGtCQUFrQjtRQUN2QixJQUFJLEtBQUssR0FBYSxLQUFLLENBQUMsa0JBQWtCLEVBQUUsQ0FBQTtRQUNoRCxJQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLFFBQVEsS0FBSyx1QkFBdUIsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLEVBQUM7WUFDdkYsS0FBSyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQTtTQUVyQztRQUNBLE9BQU8sS0FBSyxDQUFBO0lBRWpCLENBQUM7SUFFTyxLQUFLO1FBQ1osT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUNRLDBCQUEwQixDQUFDLFlBQW9DLEVBQUUsWUFBNEI7UUFDcEcsTUFBTSxPQUFPLEdBQXNDLFlBQVksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUNqRixJQUFJLE9BQU8sSUFBSSxJQUFJLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLGlCQUFpQixDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsV0FBVyxFQUFFLElBQUksdUJBQXVCLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRTtZQUNoSixPQUFPLFFBQVEsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1NBQzNDO2FBQU07WUFDTCxPQUFPLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxZQUFZLEVBQUMsWUFBWSxDQUFDLENBQUM7U0FDcEU7SUFDSCxDQUFDO0NBRUYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyAgRGF0YVNvdXJjZURlY29yYXRvciB9IGZyb20gXCIuLi8uLi9TaGFyZWQvRnJhbWV3b3JrL0RhdGFTb3VyY2VEZWNvcmF0b3JcIjtcbmltcG9ydCB7IENvbWV0Q2hhdE1lc3NhZ2VFdmVudHMsIENvbWV0Q2hhdFRoZW1lLCBDb21ldENoYXRVSUtpdENvbnN0YW50cywgTWVzc2FnZVN0YXR1cyB9IGZyb20gXCJAY29tZXRjaGF0L3Vpa2l0LXJlc291cmNlc1wiO1xuaW1wb3J0IHsgQ29tZXRDaGF0TWVzc2FnZVRlbXBsYXRlIH0gZnJvbSBcIkBjb21ldGNoYXQvdWlraXQtcmVzb3VyY2VzXCI7XG5pbXBvcnQge0NvbWV0Q2hhdH0gZnJvbSAnQGNvbWV0Y2hhdC9jaGF0LXNkay1qYXZhc2NyaXB0J1xuaW1wb3J0IHtsb2NhbGl6ZX0gZnJvbSAnQGNvbWV0Y2hhdC91aWtpdC1yZXNvdXJjZXMnXG5pbXBvcnQge1N0aWNrZXJzQ29uZmlndXJhdGlvbn0gZnJvbSAnQGNvbWV0Y2hhdC91aWtpdC1zaGFyZWQnXG5pbXBvcnQge1N0aWNrZXJzQ29uc3RhbnRzfSBmcm9tICdAY29tZXRjaGF0L3Vpa2l0LXNoYXJlZCdcbmltcG9ydCB7IERhdGFTb3VyY2UgfSBmcm9tIFwiLi4vLi4vU2hhcmVkL0ZyYW1ld29yay9EYXRhU291cmNlXCI7XG5pbXBvcnQgeyBDb21ldENoYXRTb3VuZE1hbmFnZXIsQ29tZXRDaGF0VUlLaXRVdGlsaXR5IH0gZnJvbSBcIkBjb21ldGNoYXQvdWlraXQtc2hhcmVkXCI7XG5pbXBvcnQgeyBDaGF0Q29uZmlndXJhdG9yIH0gZnJvbSBcIi4uLy4uL1NoYXJlZC9GcmFtZXdvcmsvQ2hhdENvbmZpZ3VyYXRvclwiO1xuaW1wb3J0IHsgQ29tcG9zZXJJZCB9IGZyb20gXCIuLi8uLi9TaGFyZWQvVXRpbHMvTWVzc2FnZVV0aWxzXCI7XG5pbXBvcnQgeyBDb21ldENoYXRFeGNlcHRpb24gfSBmcm9tIFwiLi4vLi4vU2hhcmVkL1V0aWxzL0NvbWVDaGF0RXhjZXB0aW9uXCI7XG5leHBvcnQgY2xhc3MgU3RpY2tlcnNFeHRlbnNpb25EZWNvcmF0b3IgZXh0ZW5kcyBEYXRhU291cmNlRGVjb3JhdG9yIHtcbiAgICBwdWJsaWMgY29uZmlndXJhdGlvbj86U3RpY2tlcnNDb25maWd1cmF0aW9uO1xuICAgIHB1YmxpYyBuZXdEYXRhU2NvcmNlITpEYXRhU291cmNlO1xuIGNvbnN0cnVjdG9yKGRhdGFTb3VyY2U6RGF0YVNvdXJjZSl7XG4gICAgIHN1cGVyKGRhdGFTb3VyY2UpXG4gICAgIHRoaXMubmV3RGF0YVNjb3JjZSA9IGRhdGFTb3VyY2U7XG4gICAgIHRoaXMuY29uZmlndXJhdGlvbiA9IG5ldyBTdGlja2Vyc0NvbmZpZ3VyYXRpb24oe30pO1xuICAgICB0aGlzLmNvbmZpZ3VyYXRpb24hLmNjU3RpY2tlckNsaWNrZWQgPSB0aGlzLnNlbmRTdGlja2VyTWVzc2FnZTtcbiB9XG4gZ2V0RGF0YVNjb3JjZSgpe1xuICAgcmV0dXJuIHRoaXMubmV3RGF0YVNjb3JjZTtcbiB9XG4gc2VuZFN0aWNrZXJNZXNzYWdlID0gKHN0aWNrZXI6e25hbWU6c3RyaW5nLHVybDpzdHJpbmd9LGxvZ2dlZEluVXNlcjpDb21ldENoYXQuVXNlcix1c2VyOkNvbWV0Q2hhdC5Vc2VyLGdyb3VwOkNvbWV0Q2hhdC5Hcm91cCxwYXJlbnRNZXNzYWdlaWQ6bnVtYmVyLG9uRXJyb3I6KChlcnJvcjpDb21ldENoYXQuQ29tZXRDaGF0RXhjZXB0aW9uKT0+dm9pZCkgfCBudWxsIHwgdW5kZWZpbmVkLGN1c3RvbVNvdW5kRm9yTWVzc2FnZXM6c3RyaW5nID0gXCJcIiwgZGlzYWJsZVNvdW5kRm9yTWVzc2FnZXM6Ym9vbGVhbiA9IGZhbHNlKT0+e1xuICAgbGV0IHJlY2VpdmVySWQ6c3RyaW5nID0gdXNlcj8uZ2V0VWlkKCkgfHwgZ3JvdXA/LmdldEd1aWQoKVxuICAgbGV0IHJlY2VpdmVyVHlwZTpzdHJpbmcgPSB1c2VyID8gQ29tZXRDaGF0VUlLaXRDb25zdGFudHMuTWVzc2FnZVJlY2VpdmVyVHlwZS51c2VyIDogQ29tZXRDaGF0VUlLaXRDb25zdGFudHMuTWVzc2FnZVJlY2VpdmVyVHlwZS5ncm91cFxuICB0cnkge1xuICAgIGNvbnN0IGN1c3RvbURhdGEgPSB7XG4gICAgICBzdGlja2VyX3VybDogc3RpY2tlci51cmwsXG4gICAgICBzdGlja2VyX25hbWU6IHN0aWNrZXIubmFtZSxcbiAgICB9O1xuICAgIGNvbnN0IGN1c3RvbVR5cGUgPSBTdGlja2Vyc0NvbnN0YW50cy5zdGlja2VyO1xuICAgIGNvbnN0IGN1c3RvbU1lc3NhZ2U6IENvbWV0Q2hhdC5DdXN0b21NZXNzYWdlID0gbmV3IENvbWV0Q2hhdC5DdXN0b21NZXNzYWdlKFxuICAgICAgcmVjZWl2ZXJJZCxcbiAgICAgIHJlY2VpdmVyVHlwZSxcbiAgICAgIGN1c3RvbVR5cGUsXG4gICAgICBjdXN0b21EYXRhXG4gICAgKTtcbiAgICBpZiAocGFyZW50TWVzc2FnZWlkKSB7XG4gICAgICBjdXN0b21NZXNzYWdlLnNldFBhcmVudE1lc3NhZ2VJZChwYXJlbnRNZXNzYWdlaWQpO1xuICAgIH1cbiAgICBjdXN0b21NZXNzYWdlLnNldE1ldGFkYXRhKHsgaW5jcmVtZW50VW5yZWFkQ291bnQ6IHRydWUgfSk7XG4gICAgKGN1c3RvbU1lc3NhZ2UgYXMgYW55KS5zZXRTZW50QXQoQ29tZXRDaGF0VUlLaXRVdGlsaXR5LmdldFVuaXhUaW1lc3RhbXAoKSk7XG4gICAgY3VzdG9tTWVzc2FnZS5zZXRNdWlkKENvbWV0Q2hhdFVJS2l0VXRpbGl0eS5JRCgpKTtcbiAgICBDb21ldENoYXRNZXNzYWdlRXZlbnRzLmNjTWVzc2FnZVNlbnQubmV4dChcbiAgICAgIHtcbiAgICAgICAgbWVzc2FnZTogY3VzdG9tTWVzc2FnZSxcbiAgICAgICAgc3RhdHVzOiBNZXNzYWdlU3RhdHVzLmlucHJvZ3Jlc3NcbiAgICAgIH1cbiAgICApXG4gICAgaWYgKCFkaXNhYmxlU291bmRGb3JNZXNzYWdlcykge1xuICAgICAgQ29tZXRDaGF0U291bmRNYW5hZ2VyLnBsYXkoY3VzdG9tU291bmRGb3JNZXNzYWdlcyA/PyBDb21ldENoYXRTb3VuZE1hbmFnZXIuU291bmQub3V0Z29pbmdNZXNzYWdlKVxuICAgIH1cbiAgICBDb21ldENoYXQuc2VuZEN1c3RvbU1lc3NhZ2UoY3VzdG9tTWVzc2FnZSlcbiAgICAgIC50aGVuKChtZXNzYWdlKSA9PiB7XG5cbiAgICAgICAgQ29tZXRDaGF0TWVzc2FnZUV2ZW50cy5jY01lc3NhZ2VTZW50Lm5leHQoe1xuICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICAgICAgc3RhdHVzOiBNZXNzYWdlU3RhdHVzLnN1Y2Nlc3NcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKGVycm9yOkNvbWV0Q2hhdC5Db21ldENoYXRFeGNlcHRpb24pID0+IHtcbiAgICAgICAgY3VzdG9tTWVzc2FnZS5zZXRNZXRhZGF0YSh7XG4gICAgICAgICAgZXJyb3I6dHJ1ZVxuICAgICAgICB9KVxuICAgICAgICBDb21ldENoYXRNZXNzYWdlRXZlbnRzLmNjTWVzc2FnZVNlbnQubmV4dCh7XG4gICAgICAgICAgbWVzc2FnZTogY3VzdG9tTWVzc2FnZSxcbiAgICAgICAgIHN0YXR1czogTWVzc2FnZVN0YXR1cy5lcnJvcixcbiAgICAgfSk7XG5cbiAgICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcjphbnkpIHtcbiAgICBpZihvbkVycm9yKXtcbiAgICAgIG9uRXJyb3IoQ29tZXRDaGF0RXhjZXB0aW9uKGVycm9yKSlcbiAgICB9XG4gIH1cbiB9XG5vdmVycmlkZSBnZXRBbGxNZXNzYWdlVGVtcGxhdGVzKCk6IENvbWV0Q2hhdE1lc3NhZ2VUZW1wbGF0ZVtdIHtcbiAgbGV0IHRlbXBsYXRlOkNvbWV0Q2hhdE1lc3NhZ2VUZW1wbGF0ZVtdID0gIHN1cGVyLmdldEFsbE1lc3NhZ2VUZW1wbGF0ZXMoKVxuICAgaWYoIXRoaXMuY2hlY2tJZlRlbXBsYXRlRXhpc3QodGVtcGxhdGUsU3RpY2tlcnNDb25zdGFudHMuc3RpY2tlcikpe1xuICAgIHRlbXBsYXRlLnB1c2godGhpcy5nZXRTdGlja2VyVGVtcGxhdGUoKSlcbiAgICAgcmV0dXJuIHRlbXBsYXRlXG4gICB9XG4gICByZXR1cm4gdGVtcGxhdGVcblxufVxub3ZlcnJpZGUgZ2V0QXV4aWxpYXJ5T3B0aW9ucyhpZDogQ29tcG9zZXJJZCwgdXNlcj86IENvbWV0Q2hhdC5Vc2VyLCBncm91cD86IENvbWV0Q2hhdC5Hcm91cCkge1xuICByZXR1cm4ge2NvbmZpZ3VyYXRpb246dGhpcy5jb25maWd1cmF0aW9uLGlkOlN0aWNrZXJzQ29uc3RhbnRzLnN0aWNrZXJ9XG59XG5nZXRTdGlja2VyVGVtcGxhdGUoKTpDb21ldENoYXRNZXNzYWdlVGVtcGxhdGV7XG5cbnJldHVybiBuZXcgQ29tZXRDaGF0TWVzc2FnZVRlbXBsYXRlKHtcbnR5cGU6U3RpY2tlcnNDb25zdGFudHMuc3RpY2tlcixcbmNhdGVnb3J5OkNvbWV0Q2hhdFVJS2l0Q29uc3RhbnRzLk1lc3NhZ2VDYXRlZ29yeS5jdXN0b20sXG5vcHRpb25zOiAobG9nZ2VkSW5Vc2VyOiBDb21ldENoYXQuVXNlciwgbWVzc2FnZU9iamVjdDogQ29tZXRDaGF0LkJhc2VNZXNzYWdlLCB0aGVtZTogQ29tZXRDaGF0VGhlbWUsIGdyb3VwPzogQ29tZXRDaGF0Lkdyb3VwKT0+e1xuIHJldHVybiBDaGF0Q29uZmlndXJhdG9yLmdldERhdGFTb3VyY2UoKS5nZXRDb21tb25PcHRpb25zKGxvZ2dlZEluVXNlciwgbWVzc2FnZU9iamVjdCwgdGhlbWUsIGdyb3VwKVxufVxufSlcbn1cbmNoZWNrSWZUZW1wbGF0ZUV4aXN0KHRlbXBsYXRlOkNvbWV0Q2hhdE1lc3NhZ2VUZW1wbGF0ZVtdLCB0eXBlOnN0cmluZyk6Ym9vbGVhbntcbiAgcmV0dXJuIHRlbXBsYXRlLnNvbWUob2JqID0+IG9iai50eXBlID09PSB0eXBlKVxufVxuXG4gb3ZlcnJpZGUgZ2V0QWxsTWVzc2FnZUNhdGVnb3JpZXMoKTogc3RyaW5nW10ge1xuICBsZXQgY2F0ZWdvcmllczpzdHJpbmdbXSA9ICBzdXBlci5nZXRBbGxNZXNzYWdlQ2F0ZWdvcmllcygpXG4gIGlmKCFjYXRlZ29yaWVzLnNvbWUoY2F0ZWdvcnkgPT4gY2F0ZWdvcnkgPT09IENvbWV0Q2hhdFVJS2l0Q29uc3RhbnRzLk1lc3NhZ2VDYXRlZ29yeS5jdXN0b20pKXtcbiAgICBjYXRlZ29yaWVzLnB1c2goQ29tZXRDaGF0VUlLaXRDb25zdGFudHMuTWVzc2FnZUNhdGVnb3J5LmN1c3RvbSlcbiAgfVxuICAgIHJldHVybiBjYXRlZ29yaWVzXG4gfVxuXG5cbiAgIG92ZXJyaWRlIGdldEFsbE1lc3NhZ2VUeXBlcygpOiBzdHJpbmdbXSB7XG4gICAgICAgbGV0IHR5cGVzOnN0cmluZ1tdID0gIHN1cGVyLmdldEFsbE1lc3NhZ2VUeXBlcygpXG4gICAgICAgaWYoIXR5cGVzLnNvbWUoY2F0ZWdvcnkgPT4gY2F0ZWdvcnkgPT09IENvbWV0Q2hhdFVJS2l0Q29uc3RhbnRzLk1lc3NhZ2VDYXRlZ29yeS5jdXN0b20pKXtcbiAgICAgICAgdHlwZXMucHVzaChTdGlja2Vyc0NvbnN0YW50cy5zdGlja2VyKVxuXG4gICAgICAgfVxuICAgICAgICByZXR1cm4gdHlwZXNcblxuICAgfVxuXG4gIG92ZXJyaWRlIGdldElkKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIFwic3RpY2tlcnNcIjtcbiAgfVxuICBvdmVycmlkZSBnZXRMYXN0Q29udmVyc2F0aW9uTWVzc2FnZShjb252ZXJzYXRpb246IENvbWV0Q2hhdC5Db252ZXJzYXRpb24sIGxvZ2dlZEluVXNlcjogQ29tZXRDaGF0LlVzZXIpOiBzdHJpbmcge1xuICAgIGNvbnN0IG1lc3NhZ2U6IENvbWV0Q2hhdC5CYXNlTWVzc2FnZSB8IHVuZGVmaW5lZCA9IGNvbnZlcnNhdGlvbi5nZXRMYXN0TWVzc2FnZSgpO1xuICAgIGlmIChtZXNzYWdlICE9IG51bGwgJiYgbWVzc2FnZS5nZXRUeXBlKCkgPT0gU3RpY2tlcnNDb25zdGFudHMuc3RpY2tlciAmJiBtZXNzYWdlLmdldENhdGVnb3J5KCkgPT0gQ29tZXRDaGF0VUlLaXRDb25zdGFudHMuTWVzc2FnZUNhdGVnb3J5LmN1c3RvbSkge1xuICAgICAgcmV0dXJuIGxvY2FsaXplKFwiQ1VTVE9NX01FU1NBR0VfU1RJQ0tFUlwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHN1cGVyLmdldExhc3RDb252ZXJzYXRpb25NZXNzYWdlKGNvbnZlcnNhdGlvbixsb2dnZWRJblVzZXIpO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=